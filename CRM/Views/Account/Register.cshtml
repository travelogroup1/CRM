
@{
    ViewData["Title"] = "Register";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<br />
<section class="content">
    <div class="container-fluid">
        <div class="card card-default">
            <div class="card-header">
                <div class="card-tools">
                    <h6 class="text-success" id="msg" style="display:none">Successfully save changes.</h6>


                </div>
                <h3 style="text-align:center;font-weight:bold">Register User</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Full Name&nbsp;<span style="color:red!important"><b>*</b></span></label>
                            <input type="hidden" class="form-control" id="UserId" name="UserId" />
                            <input type="hidden" class="form-control" id="Added_By" name="Added_By" />
                            <input type="hidden" class="form-control" id="Added_Date" name="Added_Date" />
                            <input type="text" class="form-control" id="FullName" name="FullName" tabindex="1" />
                        </div>
                        <div class="form-group">
                            <label>User Name &nbsp;<span style="color:red!important"><b>*</b></span></label>
                            <input type="text" class="form-control" id="UserName" name="UserName" tabindex="3" readonly/>
                        </div>
                        <div class="form-group">
                            <label>CNIC &nbsp;<span style="color:red!important"><b>*</b></span></label>
                            <input type="text" data-inputmask="'mask': '99999-9999999-9'" placeholder="XXXXX-XXXXXXX-X" class="form-control" id="CNIC" name="CNIC" tabindex="4" />
                        </div>

                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Emergency Contact &nbsp;<span style="color:red!important"><b>*</b></span></label>
                            <input type="text" data-inputmask="'mask': '0399-99999999'" placeholder="XXXXX-XXXXXXX" maxlength="12" class="form-control" id="Emergency_Contact" name="Emergency_Contact" tabindex="2" />
                        </div>
                        <div class="form-group">
                            <label>Official Mobile   &nbsp;<span style="color:red!important"><b>*</b></span></label>
                            <input type="text" data-inputmask="'mask': '0399-99999999'" placeholder="XXXXX-XXXXXXX" maxlength="12" class="form-control" id="OfficialMobile" name="OfficialMobile" tabindex="12" />
                        </div>
                        <div class="form-group">
                            <label>Personal_Mobile   &nbsp;<span style="color:red!important"><b>*</b></span></label>
                            <input type="text" data-inputmask="'mask': '0399-99999999'" placeholder="XXXXX-XXXXXXX" maxlength="12" class="form-control" id="Personal_Mobile" name="Personal_Mobile" tabindex="13" />
                        </div>



                    </div>
                    <div class="col-md-6">
                        <div class="form-group mt-2">
                            <label>House Location  &nbsp;<span style="color:red!important"><b>*</b></span></label>
                            <input type="text" class="form-control" id="House_Location" name="House_Location" tabindex="6" />
                        </div>
                        <div class="form-group">
                            <label>Address &nbsp;<span style="color:red!important"><b>*</b></span></label>
                            <textarea type="text" cols="2" rows="2" class="form-control" id="Address" name="Address" tabindex="5"></textarea>
                        </div>
                        <div class="form-group">
                            <label>CNIC Front Image   &nbsp;<span style="color:red!important"><b>*</b></span></label><br />
                            <input accept="image/*" type='file' id="CNIC_Front_Image" onchange="document.getElementById('previewCNIC_Front_Image').src = window.URL.createObjectURL(this.files[0])" tabindex="15" />
                            <img id="previewCNIC_Front_Image" src="#" alt="your image" width="200" height="200" />
                        </div>
                    </div>
                    <div class="col-md-6">

                        <div class="form-group">
                            <label for="Category">Select User Category: &nbsp;<span style="color:red!important"><b>*</b></span></label>

                            <select name="Category" id="Category" class="form-control" tabindex="8">
                                <option value="0">Not Selected</option>
                                <option value="SPO">SPO</option>
                                <option value="Rider">Rider</option>
                                <option value="Accounts">Accounts</option>
                                <option value="IT">I.T</option>
                                <option value="HR">H.R</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="Status">Select User Status: &nbsp;<span style="color:red!important"><b>*</b></span></label>

                            <select name="Status" id="Status" class="form-control" tabindex="10">
                                <option value="0">Not Selected</option>
                                <option value="Pending">Pending</option>
                                <option value="Reject">Reject</option>
                                <option value="Active">Active</option>
                                <option value="New">New</option>
                                <option value="HR">H.R</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="Branch">Select Branch: &nbsp;<span style="color:red!important"><b>*</b></span></label>

                            <select name="Branch" id="Branch" class="form-control" tabindex="10">
                                <option value="0">Not Selected</option>
                                @if (ViewBag.BranchList != null)
                                {
                                    @foreach (var item in ViewBag.BranchList)
                                    {
                                        <option value="@item.BranchId">@item.BranchName</option>
                                    }
                                }

                            </select>
                        </div>


                    </div>

                    <div class="col-md-6">



                        <div class="form-group">
                            <label>CNIC Back Image   &nbsp;<span style="color:red!important"><b>*</b></span></label><br />
                            <input accept="image/*" type='file' id="CNIC_Back_Image" onchange="document.getElementById('previewCNIC_Back_Image').src = window.URL.createObjectURL(this.files[0])" tabindex="14" />
                            <img id="previewCNIC_Back_Image" src="#" alt="your image" width="200" height="200" />
                        </div>

                        <div class="form-group">
                            <label>Uplaod Agreement   &nbsp;<span style="color:red!important"><b>*</b></span></label><br />
                            <input accept="application/pdf,application/msword" type="file" id="Agreement" tabindex="16" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Profile Picture   &nbsp;<span style="color:red!important"><b>*</b></span></label><br />
                            <input accept="image/*" type='file' id="ProfilePicture" onchange="document.getElementById('previewProfilePicture').src = window.URL.createObjectURL(this.files[0])" tabindex="16" />
                            <img id="previewProfilePicture" src="#" alt="your image" width="200" height="200" />
                        </div>

                        <div class="form-group" style="padding-top: 22px;">
                            <label></label>
                            <button class="btn btn-success mt-2" id="addupbtn">Add User</button>

                            @*<button class="btn btn-success mt-2" id="addupbtn" onclick="CheckValidation()">Add User</button>*@
                        </div>



                    </div>

                </div>
            </div>
        </div>
    </div>
</section>
<br />
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">

                        <div class="row">
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="usertype">Select User Type: &nbsp;<span style="color:red!important"><b>*</b></span></label>

                                    <select name="usertype" id="usertype" class="form-control bg-info"  tabindex="10" >
                                        <option value="0" selected >Active</option>
                                        <option value="1" >De-Active</option>

                                    </select>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="card-body">
                        <table id="example1" class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Profile Picture</th>
                                    <th>Full Name</th>

                                    <th>Official Mobile</th>

                                    <th>Branch</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Attachments</th>

                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usertbl"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="modal fade" id="modal-lg">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="text-center"><b>Attachments</b></h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-6">
                        <div>
                            <h4 style="margin-left:2px">CNIC Front:</h4>
                            <img src="" class="w-auto" alt="your image" id="fimg" />

                        </div>
                    </div>
                    <div class="col-6">
                        <div>
                            <h4 style="margin-left:2px">CNIC Back:</h4>
                            <img src="" alt="your image" class="w-auto" id="bimg" />

                        </div>
                    </div>
                    <div class="col-6">
                        <div>
                            <h4>Employee Agreement:</h4>
                            <a class="btn btn-info" download="EmployeeAgreementPdf" id="agreementf"><span style="color:green">Download<i class="fas fa-cloud-download-alt fa-lg"></i></span></a>
                        </div>
                    </div>
                </div>
                          </div>

        </div>

        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
@section Scripts
{
    <script type="text/javascript">
        $(function () {
            $("#CNIC,#Emergency_Contact,#OfficialMobile,#Personal_Mobile").each(function () {
                $(this).inputmask({
                    //whateveryouwant
                });


            });
            //$("#").inputmask();

            GetAllUsers(0);
            window.alert = function () { }
        });
        //$('#profileimage').on("change", function () {
        //    var myFile = $('#profileimage').prop('files');
        //    const [file] = imyFile
        //    if (file) {
        //        previewprofileimage.src = URL.createObjectURL(file)
        //});
        $('#usertype').on('change', function () {
            alert((this.value));
            GetAllUsers(this.value);
        });


        function GetAllUsers(usertype) {
            var userdata = {};
            userdata.IsDeleted = usertype;

            debugger;
            $.ajax({
                type: 'GET',
                url: '/Account/GetAllUsers',
                data: userdata,
                success: function (response) {

                    console.log(response);
                    debugger;
                    var op = '';
                    $.each(response, function (key, item) {
                        alert(item.Id);
                        var ProfileBase64 = `data:image/png;base64,${item.ProfileBase64}`;
                        var CNICFrontBase64 = `data:image/png;base64,${item.CNICFrontBase64}`;
                        var CNICBackBase64 = `data:image/png;base64,${item.CNICBackBase64}`;

                        op+='<tr>';
                        op += '<td><div class="mt-3 ml-3 pl-3"><img  src="' + ProfileBase64 + '" alt="profile image" width="40" height="40"></div></td>';
                        op+='<td>'+ item.FullName + '</td>';
                        op+='<td>'+ item.OfficialMobile + '</td>';

                        op+='<td>' + item.BranchName +'</td>';
                        op += '<td>' + item.Category + '</td>';
                        op += '<td>' + item.Status + '</td >';
                        op += '<td><div class="mt-2 pt-2 ml-4 pl-4"><a  onclick="showattach(\'' + CNICFrontBase64 + '\',\'' + CNICBackBase64 + '\' ,\'' + item.AgreementFilePath + '\')"><span style="color:#482029"><i class="fas fa-paperclip fa-lg"></i></span></a></div></td>';

                        op+= '<td><div class="mt-2 pt-2"><a class="mr-1"  onclick="getuserbyid(\'' + item.Id + '\')"><span style="color:green"><i class="fas fa-user-edit fa-lg"></i></span></a><a  onclick="deluser(\'' + item.Id + '\')"><span style="color:red"><i class="fas fa-trash-alt fa-lg"></i></span></a></div></td></tr>';
                    });
                    $('#usertbl').empty().append(op);
                    DatatablesUser();
                },
                failure: function (response) {
                    $('#result').html(response);
                }
            });
        }
        function DatatablesUser() {
            $("#example1").DataTable({
                "responsive": false,

                "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"]
            }).buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');
        }


        $('#addupbtn').click(function () {
            debugger;


            var UserId = $('#UserId').val();
            alert(UserId);
            if (UserId != "") {

                var fname = $('#FullName').val();
                var UserName = $('#UserName').val();

                var Emergency_Contact = $('#Emergency_Contact').val();
                var CNIC = $('#CNIC').val();


                var OfficialMobile = $('#OfficialMobile').val();
                var Status = $('#Status').val();
                var Personal_Mobile = $('#Personal_Mobile').val();
                var Category = $('#Category').val();
                var Branch = $('#Branch').val();

                var cnicbackimg = $('#previewCNIC_Back_Image').attr('src');
                var cnicfrontimg = $('#previewCNIC_Front_Image').attr('src');
                var profileimg = $('#previewProfilePicture').attr('src');



                var CNIC_Back_Image1 = $('#CNIC_Back_Image').val();
                var CNIC_Front_Image1 = $('#CNIC_Front_Image').val();
                var ProfilePicture1 = $('#ProfilePicture').val();
                if ($('#Agreement').val() != "") {
                    var fileupload = $('#Agreement').val();
                    var allowedFiles = [".doc", ".docx", ".pdf"];
                    var regex = new RegExp("([a-zA-Z0-9\s_\\.\-:])+(" + allowedFiles.join('|') + ")$");
                    debugger;
                    if (!regex.test(fileUpload.toLowerCase())) {
                        toastr.error('Please upload files having extensions: <b>" + allowedFiles.join(', ') + "</b> only.');
                        return false;
                    }
                }
                else
                {


                }
                if (
                    fname == "" ||
                    UserName == "" ||
                    Emergency_Contact == "" ||
                    CNIC == "" ||
                    OfficialMobile == "" ||
                    status == '0' ||
                    Personal_Mobile == "" ||
                    Category == '0' ||
                    Branch == '0' ||
                    fname == null ||
                    UserName == null ||
                    Emergency_Contact == null ||
                    CNIC == null ||
                    OfficialMobile == null


                ) {
                    // AddUser();
                    toastr.error('Required Fields are Mandatory...!');
                }
                else {
                    alert('update');
                    AddUser();
                }
            }
            else {
                debugger;

                if ($('#Agreement').val() != "") {
                    var fileupload = $('#Agreement').val();
                    var allowedFiles = [".doc", ".docx", ".pdf"];
                    var regex = new RegExp("([a-zA-Z0-9\s_\\.\-:])+(" + allowedFiles.join('|') + ")$");
                    debugger;
                    if (!regex.test(fileupload.toLowerCase() ) ) {


                        toastr.error('Please upload files having extensions: ".doc", ".docx", ".pdf" only.');
                        return false;
                    }
                }
                else {

                    AddUser();

                }
                var fname = $('#FullName').val();
                var UserName = $('#UserName').val();

                var Emergency_Contact = $('#Emergency_Contact').val();
                var CNIC = $('#CNIC').val();



                var OfficialMobile = $('#OfficialMobile').val();
                var Status = $('#Status').val();
                var Personal_Mobile = $('#Personal_Mobile').val();
                var Category = $('#Category').val();
                var Branch = $('#Branch').val();




                if (
                    fname == "" ||
                    UserName == "" ||
                    Emergency_Contact == "" ||
                    CNIC == "" ||
                    OfficialMobile == "" ||
                    status == '0' ||
                    Personal_Mobile == "" ||
                    Category == '0' ||
                    Branch == '0' ||
                    fname == null ||
                    UserName == null ||
                     Emergency_Contact == null ||
                    CNIC == null ||
                    OfficialMobile == null
                ) {

                    toastr.error('Required Fields are Mandatory...!');
                }
                else {

                    AddUser();
                }


            }


        });
        function AddUser() {

            debugger;

            var btn_name = $('#addupbtn').text();
            var iscnicfrontfile = 0;
            var iscnicbackfile = 0;
            var isprofilefile = 0;
            var isagreement = 0;
            if (btn_name == "Update") {
                var userdata = new FormData();
                var frntimgfile = $('#CNIC_Front_Image').get(0).files[0];
                var backimgfile = $('#CNIC_Back_Image').get(0).files[0];
                var profileimgfile = $('#ProfilePicture').get(0).files[0];
                if ($('#CNIC_Front_Image').val()=="") {
                    iscnicfrontfile = 0;
                }
                else {
                    userdata.append("frntimgfile", frntimgfile);
                    iscnicfrontfile = 1;

                }

                if ($('#CNIC_Back_Image').val() == "") {
                    iscnicbackfile = 0;
                }
                else {
                    userdata.append("backimgfile", backimgfile);
                    iscnicbackfile = 1;
                }


                if ($('#ProfilePicture').val() == "") {
                    isprofilefile = 0;
                }
                else {
                    userdata.append("profileimgfile", profileimgfile);
                    isprofilefile = 1;
                }

                if ($('#Agreement').val() == "") {
                    isagreement = 0;
                }
                else {
                    userdata.append("AgreementFile", AgreementFile);
                    isagreement = 1;
                }

                userdata.append("isprofilefile", isprofilefile);
                userdata.append("iscnicbackfile", iscnicbackfile);
                userdata.append("iscnicfrontfile", iscnicfrontfile);

                userdata.append("FullName", $('#FullName').val());

                userdata.append("UserId", $('#UserId').val());


                userdata.append("UserName", $('#UserName').val());
                userdata.append("Address", $('#Address').val());
                userdata.append("Emergency_Contact", $('#Emergency_Contact').val());
                userdata.append("CNIC", $('#CNIC').val());
                userdata.append("House_Location", $('#House_Location').val());


                userdata.append("OfficialMobile", $('#OfficialMobile').val());
                userdata.append("Status", $('#Status').val());
                userdata.append("Personal_Mobile", $('#Personal_Mobile').val());
                userdata.append("Category", $('#Category').val());
                userdata.append("Branch", $('#Branch').val());

                $.ajax({
                    url: '/Account/UpdateUser',
                    type: "POST",
                    processData: false,
                    contentType: false,
                    data: userdata,
                    success: function (response) {
                        var Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, progressBar: true, timer: 3000 });
                        Toast.fire({ icon: 'success', title: 'User Update Successfully..!' })
                        $('#addupbtn').empty().text('Add User');
                        RefreshPage();
                    },
                    failure: function (response) {
                        $('#result').html(response);
                    }
                });

            }
            else {

                // Create FormData object
                var iscnicfrontfile = 0;
                var iscnicbackfile = 0;
                var isprofilefile = 0;
                var IsAgreement = 0;

                var userdata = new FormData();
                var frntimgfile = $('#CNIC_Front_Image').get(0).files[0];
                var backimgfile = $('#CNIC_Back_Image').get(0).files[0];
                var profileimgfile = $('#ProfilePicture').get(0).files[0];
                var AgreementFile = $('#Agreement').get(0).files[0];

                if ($('#CNIC_Front_Image').val() == "") {
                    iscnicfrontfile = 0;
                }
                else {
                    userdata.append("frntimgfile", frntimgfile);
                    iscnicfrontfile = 1;

                }

                if ($('#CNIC_Back_Image').val() == "") {
                    iscnicbackfile = 0;
                }
                else {
                    userdata.append("backimgfile", backimgfile);
                    iscnicbackfile = 1;
                }


                if ($('#ProfilePicture').val() == "") {
                    isprofilefile = 0;
                }
                else {
                    userdata.append("profileimgfile", profileimgfile);
                    isprofilefile = 1;
                }

                if ($('#Agreement').val() == "") {
                    IsAgreement = 0;
                }
                else {
                    userdata.append("AgreementFile", AgreementFile);
                    IsAgreement = 1;
                }

                userdata.append("isprofilefile", isprofilefile);
                userdata.append("iscnicbackfile", iscnicbackfile);
                userdata.append("iscnicfrontfile", iscnicfrontfile);
                userdata.append("IsAgreement", IsAgreement);


                userdata.append("FullName", $('#FullName').val());

                userdata.append("UserName", $('#UserName').val());
                userdata.append("Address", $('#Address').val());
                userdata.append("Emergency_Contact", $('#Emergency_Contact').val());
                userdata.append("CNIC", $('#CNIC').val());
                userdata.append("House_Location", $('#House_Location').val());


                userdata.append("OfficialMobile", $('#OfficialMobile').val());
                userdata.append("Status", $('#Status').val());
                userdata.append("Personal_Mobile", $('#Personal_Mobile').val());
                userdata.append("Category", $('#Category').val());
                userdata.append("Branch", $('#Branch').val());

                $.ajax({
                    url: '/Account/RegisterPost',
                    type: "POST",
                    processData: false,
                    contentType: false,
                    data: userdata,
                    success: function (response) {
                        var Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, progressBar: true, timer: 3000 });
                        Toast.fire({ icon: 'success', title: 'User Registerd Successfully..!' })
                        RefreshPage();
                    },
                    failure: function (response) {
                        $('#result').html(response);
                    }
                });
            }
        }

        function getuserbyid(userid) {
            $.ajax({
                type: 'POST',
                url: '/Account/GetUserById',
                data: {
                    "Id": userid
                },
                success: function (response) {
                    debugger;
                    $('#addupbtn').empty().text('Update');

                    $('#UserId').val(response.Id);

                    $('#FullName').val(response.FullName);
                    $('#UserName').val(response.UserName);
                    $('#Address').val(response.Address);
                    $('#Emergency_Contact').val(response.Emergency_Contact);
                    $('#CNIC').val(response.CNIC);
                    $('#House_Location').val(response.House_Location);



                    $('#OfficialMobile').val(response.OfficialMobile);
                    $('#Status').val(response.Status);
                    $('#Personal_Mobile').val(response.Personal_Mobile);
                    $('#Category').val(response.Category);
                    $('#Branch').val(response.BranchId);
                    var CNIC_Back_Image1 = $('#CNIC_Back_Image').prop('files');
                    var CNIC_Front_Image1 = $('#CNIC_Front_Image').prop('files');
                    var ProfilePicture1 = $('#ProfilePicture').prop('files');

                    var ProfileBase64 = `data:image/png;base64,${response.ProfileBase64}`;
                    var CNICFrontBase64 = `data:image/png;base64,${response.CNICFrontBase64}`;
                    var CNICBackBase64 = `data:image/png;base64,${response.CNICBackBase64}`;


                    $('#previewCNIC_Back_Image').attr("src", CNICBackBase64);
                    $('#previewCNIC_Front_Image').attr("src", CNICFrontBase64);
                    $('#previewProfilePicture').attr("src", ProfileBase64);

                },
                failure: function (response) {
                    $('#result').html(response);
                }
            });

        }
        function deluser(userId) {

            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        type: 'POST',
                        url: '/Account/DeleteUser',
                        data: {
                            "Id": userId
                        },
                        success: function (response) {
                            Swal.fire('Deleted!', 'Your User has been deleted.', 'success')
                            RefreshPage();
                        },
                        failure: function (response) {
                            $('#result').html(response);
                        }
                    });
                }
            })
        }
        function showattach(cnicfront, cnicback, aggermentfile) {
            $("#fimg").attr("src", cnicfront);
            $("#bimg").attr("src", cnicback);
            var filefullpath = location.protocol + '//' + location.host + aggermentfile;
            $('#agreementf').attr("href", filefullpath);
            $('#modal-lg').modal('show');
        }
        $("#FullName").change(function () {
            debugger;

            var fullName = $("#FullName").val().trim();
            var fullNameArray = fullName.split(' ');

            if (fullNameArray.length > 2 || fullNameArray.length < 2) {
                toastr.error('Full Name only include 2 words like "ADIL KHAN"...! and only one white space in between');
                return false;
            }
            else {
                $.ajax({
                    type: 'POST',
                    url: '/Account/CheckUserExist',
                    data: {
                        "FullName": fullName
                    },
                    success: function (response) {
                        if (response == '0') {
                            $("#UserName").val(fullNameArray[0] + '.' + fullNameArray[1]);
                        }
                        if (response == '1') {
                            $("#UserName").val(fullNameArray[0] + '.' + fullNameArray[1]+'1');
                        }

                    },
                    failure: function (response) {
                        $('#result').html(response);
                    }
                });

            }

        });

    </script>


}
@*<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/3/jquery.inputmask.bundle.js"></script>*@






